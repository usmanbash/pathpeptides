<!-- Dynamic Related Products Section -->
<section class="px-0 py-12 sm:py-0">
    <div class="bg-[#f8f8f8] rounded-3xl">
        <div class="px-[20px] py-[64px] lg:px-[82px] lg:py-[120px] flex flex-col gap-[54px] items-start relative w-[100%] sm:max-w-[1440px] mx-auto">
            <product-recommendations
                class="w-full"
                data-url="{{ routes.product_recommendations_url }}?limit={{ section.settings.products_to_show | default: 4 }}"
                data-section-id="{{ section.id }}"
                data-product-id="{{ product.id }}"
            >
                {% if recommendations.performed and recommendations.products_count > 0 %}
                    <div class="flex flex-col lg:flex-row items-start lg:items-end gap-6 w-full border-b border-[#E9E9E9] pb-[54px]">
                        <div class="flex flex-col gap-[34px] items-start flex-1 max-w-full lg:max-w-[636px]">
                            <div class="flex flex-col gap-[5px] items-start w-full">
                                <h1 class="text-3xl sm:text-4xl md:text-5xl leading-tight md:leading-[58px] text-[#0C0C0C] font-normal">
                                    {{ section.settings.heading | default: "Related products" }}
                                </h1>
                                <p class="text-base sm:text-lg leading-relaxed text-[#0C0C0C] font-normal">
                                    {{ section.settings.description | default: "Discover complementary peptide solutions to enhance your results and support your overall wellness." }}
                                </p>
                            </div>
                        </div>
                        {% if recommendations.products_count > 1 %}
                            <div class="flex flex-row gap-3 items-start relative w-full sm:w-auto justify-between sm:justify-start">
                                <button class="swiper-button-prev-collection">
                                    <div class="overflow-hidden rounded-[50px] relative w-[50px] h-[50px] bg-white flex items-center justify-center">
                                        <svg width="11" height="18" viewBox="0 0 11 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path fill-rule="evenodd" clip-rule="evenodd" d="M0.505868 9.56804C0.176355 9.25421 0.176355 8.7455 0.505868 8.43168L9.10818 0.23902C9.43769 -0.0747906 9.97184 -0.0747906 10.3014 0.23902L10.6992 0.617834C11.0287 0.931645 11.0287 1.44043 10.6992 1.75426L3.09123 8.99986L10.6992 16.2455C11.0287 16.5593 11.0287 17.068 10.6992 17.3819L10.3014 17.7607C9.97184 18.0745 9.43769 18.0745 9.10818 17.7607L0.505868 9.56804Z" fill="#B8AF9F" />
                                        </svg>
                                    </div>
                                </button>
                                <button class="swiper-button-next-collection">
                                    <div class="rounded-[50px] relative w-[50px] h-[50px] bg-[#008cff] flex items-center justify-center">
                                        <svg width="12" height="20" viewBox="0 0 12 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <g clip-path="url(#clip0_29_1178)">
                                                <path fill-rule="evenodd" clip-rule="evenodd" d="M11.4941 9.43184C11.8236 9.74566 11.8236 10.2544 11.4941 10.5682L2.89182 18.7609C2.56231 19.0747 2.02816 19.0747 1.69864 18.7609L1.30085 18.382C0.971333 18.0682 0.971333 17.5594 1.30085 17.2456L8.90877 10L1.30084 2.75438C0.971332 2.44056 0.971332 1.93184 1.30084 1.61802L1.69864 1.23916C2.02816 0.925342 2.56231 0.925342 2.89182 1.23916L11.4941 9.43184Z" fill="white" />
                                            </g>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="swiper mySwiperProductsList w-full">
                        <div class="swiper-wrapper">
                            {% for recommendation in recommendations.products %}
                                <div class="swiper-slide">
                                    <div class="rounded-[20px] border border-[#e9e9e9] pt-0 pb-5 flex flex-col gap-0 items-start flex-1 relative w-full bg-white">
                                        <div class="border border-t-0 border-l-0 border-r-0 border-b-1 border-[#e9e9e9] w-full">
                                            {% if recommendation.featured_media %}
                                                <img src="{{ recommendation.featured_media | image_url: width: 400 }}" 
                                                     alt="{{ recommendation.featured_media.alt | escape }}" 
                                                     class="block mx-auto w-full h-auto" 
                                                     loading="lazy" />
                                            {% else %}
                                                {{ 'product-apparel-2.png' | placeholder_svg_tag: 'block mx-auto w-full h-auto' }}
                                            {% endif %}
                                        </div>
                                        <div class="p-6 flex flex-col gap-5 items-start self-stretch relative w-full">
                                            <div class="flex flex-col gap-5 items-start self-stretch relative">
                                                <div class="flex justify-between items-center self-stretch relative w-full">
                                                    <p class="text-lg leading-[22px] text-[#0c0c0c]">
                                                        <span class="text-[#0c0c0c] text-lg font-semibold">{{ recommendation.title }}</span>
                                                    </p>
                                                    {% if recommendation.metafields.custom.purity %}
                                                        <small class="text-sm leading-[18px] text-[#0c0c0c]">
                                                            <span class="text-[#0c0c0c] text-sm font-normal">Purity: {{ recommendation.metafields.custom.purity }}</span>
                                                        </small>
                                                    {% endif %}
                                                </div>
                                                <div class="flex flex-col gap-2 items-start self-stretch relative w-full">
                                                    <p class="text-base leading-[21px] text-[#0c0c0c]">
                                                        <span class="text-[#0c0c0c] text-base font-semibold">Intended Use:</span>
                                                    </p>
                                                    <p class="text-base leading-[21px] text-[#303030]">
                                                        <span class="text-[#303030] text-base font-normal">
                                                            {% if recommendation.metafields.custom.intended_use %}
                                                                {{ recommendation.metafields.custom.intended_use }}
                                                            {% else %}
                                                                For research purposes only. Not for human or veterinary use.
                                                            {% endif %}
                                                        </span>
                                                    </p>
                                                </div>
                                                {% if recommendation.has_only_default_variant == false %}
                                                    <div class="flex flex-row sm:flex-row gap-4 w-full order-1 sm:order-2">
                                                        {% unless recommendation.options[0] == 'Title' %}
                                                            <div class="flex flex-col gap-2 w-full sm:w-auto">
                                                                <label class="text-[14px] sm:text-base text-[#303030]">{{ recommendation.options[0] }}:</label>
                                                                <div class="relative">
                                                                    <select class="appearance-none w-[80px] rounded-full bg-[#f8f5ef] px-[12px] py-[12px] w-full text-gray-800 text-sm focus:outline-none cursor-pointer variant-selector" 
                                                                            data-product-id="{{ recommendation.id }}">
                                                                        {% for variant in recommendation.variants %}
                                                                            <option value="{{ variant.id }}" 
                                                                                    {% if variant.available == false %}disabled{% endif %}
                                                                                    {% if variant == recommendation.selected_or_first_available_variant %}selected{% endif %}>
                                                                                {{ variant.option1 }}
                                                                            </option>
                                                                        {% endfor %}
                                                                    </select>
                                                                    <svg class="pointer-events-none absolute right-3 top-[30px] -translate-y-1/2 w-4 h-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                                                    </svg>
                                                                </div>
                                                            </div>
                                                        {% endunless %}
                                                        <div class="flex flex-col gap-2 w-full sm:w-auto">
                                                            <label class="text-[14px] sm:text-base text-[#303030]">Amount:</label>
                                                            <div class="flex items-center rounded-full bg-[#f8f5ef] px-3 py-2 gap-4">
                                                                <button class="quantity-decrease text-gray-600 text-lg font-light focus:outline-none" type="button">−</button>
                                                                <input type="number" class="quantity-input text-gray-800 text-sm bg-transparent border-none outline-none w-8 text-center" 
                                                                       value="1" min="1" name="quantity" id="quantity-{{ recommendation.id }}">
                                                                <button class="quantity-increase text-gray-600 text-lg font-light focus:outline-none" type="button">+</button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                            <div class="flex justify-between items-center self-stretch relative w-full">
                                                <span class="flex items-center gap-2">
                                                    {% if recommendation.compare_at_price > recommendation.price %}
                                                        <h3 class="text-[26px] leading-[34px] text-[#303030]">
                                                            <span class="text-[#303030] text-[26px] font-light">{{ recommendation.price | money }}</span>
                                                        </h3>
                                                        <h5 class="text-xl leading-[26px] line-through text-[#303030]/40">
                                                            <span class="text-[#303030]/40 text-xl font-light">{{ recommendation.compare_at_price | money }}</span>
                                                        </h5>
                                                    {% else %}
                                                        <h3 class="text-[26px] leading-[34px] text-[#303030]">
                                                            <span class="text-[#303030] text-[26px] font-light">{{ recommendation.price | money }}</span>
                                                        </h3>
                                                    {% endif %}
                                                </span>
                                                <p class="text-base leading-[21px] {% if recommendation.available %}text-[#008cff]{% else %}text-red-500{% endif %}">
                                                    <span class="{% if recommendation.available %}text-[#008cff]{% else %}text-red-500{% endif %} text-base font-normal">
                                                        {% if recommendation.available %}In stock{% else %}Out of stock{% endif %}
                                                    </span>
                                                </p>
                                            </div>
                                            <div class="flex flex-col gap-2.5 items-start self-stretch relative w-full">
                                                <div class="flex justify-between items-center self-stretch relative w-full">
                                                    <div class="rounded-[50px] flex flex-col gap-6 justify-center items-center relative w-full h-11 {% if recommendation.available %}bg-[#008cff]{% else %}bg-gray-400{% endif %}">
                                                        <button class="add-to-cart-btn rounded-[50px] px-6 py-3 flex gap-2 justify-center items-center self-stretch relative w-full h-11"
                                                                data-product-id="{{ recommendation.id }}"
                                                                data-variant-id="{{ recommendation.selected_or_first_available_variant.id }}"
                                                                {% unless recommendation.available %}disabled{% endunless %}>
                                                            <p class="text-base leading-6 uppercase text-[#f8f5ef]">
                                                                <span class="text-[#f8f5ef] text-base font-bold">
                                                                    {% if recommendation.available %}Add to cart{% else %}Sold out{% endif %}
                                                                </span>
                                                            </p>
                                                            {% if recommendation.available %}
                                                                <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                                    <g clip-path="url(#clip0_29_1215)">
                                                                        <path d="M7.90904 19.2747C6.81092 19.2747 5.91748 18.3812 5.91748 17.2831C5.91748 16.185 6.81092 15.2919 7.90904 15.2919C9.00717 15.2919 9.90061 16.185 9.90061 17.2831C9.90061 18.3812 9.00717 19.2747 7.90904 19.2747ZM7.90904 16.5419C7.50029 16.5419 7.16748 16.8744 7.16748 17.2831C7.16748 17.6922 7.49998 18.0247 7.90904 18.0247C8.31811 18.0247 8.65061 17.6922 8.65061 17.2831C8.65061 16.8744 8.31811 16.5419 7.90904 16.5419Z" fill="white" />
                                                                        <path d="M14.8321 19.2747C13.7339 19.2747 12.8408 18.3812 12.8408 17.2831C12.8408 16.185 13.7339 15.2919 14.8321 15.2919C15.9302 15.2919 16.8236 16.185 16.8236 17.2831C16.8236 18.3812 15.9299 19.2747 14.8321 19.2747ZM14.8321 16.5419C14.4233 16.5419 14.0908 16.8744 14.0908 17.2831C14.0908 17.6922 14.4233 18.0247 14.8321 18.0247C15.2411 18.0247 15.5736 17.6922 15.5736 17.2831C15.5736 16.8744 15.2408 16.5419 14.8321 16.5419Z" fill="white" />
                                                                        <path d="M16.2901 13.7482H6.47168C5.51637 13.7482 4.70043 13.0978 4.4873 12.1666L2.44949 3.26753C2.42262 3.15003 2.34137 3.0494 2.23199 2.99878L0.541679 2.21534C0.150429 2.03409 -0.0198839 1.56972 0.161366 1.17815C0.342616 0.786903 0.807304 0.616591 1.19855 0.797841L2.88887 1.58128C3.43355 1.83347 3.83887 2.33347 3.97262 2.91878L6.01043 11.8185C6.0598 12.0347 6.24949 12.186 6.47168 12.186H16.2901C16.5114 12.186 16.7007 12.0357 16.7514 11.82L18.3357 5.00347C18.3811 4.80972 18.2986 4.66878 18.2457 4.60222C18.1926 4.53534 18.0739 4.42347 17.8751 4.42347H6.31262C5.88105 4.42347 5.53137 4.07378 5.53137 3.64222C5.53137 3.21065 5.88105 2.86097 6.31262 2.86097H17.8751C18.4998 2.86097 19.0804 3.14128 19.4692 3.63034C19.8579 4.1194 19.9992 4.74878 19.8579 5.35722L18.2732 12.1741C18.0573 13.1007 17.242 13.7482 16.2901 13.7482Z" fill="white" />
                                                                    </g>
                                                                    <defs>
                                                                        <clipPath id="clip0_29_1215">
                                                                            <rect width="20" height="20" fill="white" />
                                                                        </clipPath>
                                                                    </defs>
                                                                </svg>
                                                            {% endif %}
                                                        </button>
                                                    </div>
                                                </div>
                                                <a href="{{ recommendation.url }}" class="rounded-[50px] border border-[#008cff] px-6 py-3 flex gap-2 justify-center items-center self-stretch relative w-full h-11 text-decoration-none">
                                                    <p class="text-base leading-6 uppercase text-black">
                                                        <span class="text-black text-base font-normal">Learn More</span>
                                                    </p>
                                                </a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                {% endif %}
            </product-recommendations>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Swiper for product recommendations
    const swiper = new Swiper('.mySwiperProductsList', {
        slidesPerView: 1,
        spaceBetween: 20,
        navigation: {
            nextEl: '.swiper-button-next-collection',
            prevEl: '.swiper-button-prev-collection',
        },
        breakpoints: {
            640: { slidesPerView: 2, spaceBetween: 20 },
            768: { slidesPerView: 3, spaceBetween: 30 },
            1024: { slidesPerView: 4, spaceBetween: 30 },
        },
    });

    // Quantity controls
    document.querySelectorAll('.quantity-decrease').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.nextElementSibling;
            const value = parseInt(input.value);
            if (value > 1) input.value = value - 1;
        });
    });

    document.querySelectorAll('.quantity-increase').forEach(btn => {
        btn.addEventListener('click', function() {
            const input = this.previousElementSibling;
            input.value = parseInt(input.value) + 1;
        });
    });

    // Variant selector functionality
    document.querySelectorAll('.variant-selector').forEach(select => {
        select.addEventListener('change', function() {
            const variantId = this.value;
            const addToCartBtn = this.closest('.swiper-slide').querySelector('.add-to-cart-btn');
            if (addToCartBtn) addToCartBtn.dataset.variantId = variantId;
        });
    });

    // Add to cart functionality
    document.querySelectorAll('.add-to-cart-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (this.disabled) return;
            
            const productId = this.dataset.productId;
            const variantId = this.dataset.variantId;
            const quantityInput = document.querySelector(`#quantity-${productId}`);
            const quantity = quantityInput ? parseInt(quantityInput.value) : 1;
            
            fetch('/cart/add.js', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ id: variantId, quantity: quantity })
            })
            .then(response => response.json())
            .then(data => {
                console.log('Product added to cart:', data);
                if (window.cart && window.cart.refresh) window.cart.refresh();
            })
            .catch(error => console.error('Error adding to cart:', error));
        });
    });
});
</script>

{% schema %}
{
  "name": "Custom Related Products",
  "tag": "section",
  "class": "section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "Related products",
      "label": "Heading"
    },
    {
      "type": "textarea",
      "id": "description",
      "default": "Discover complementary peptide solutions to enhance your results and support your overall wellness.",
      "label": "Description"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 10,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    }
  ],
  "presets": [
    {
      "name": "Custom Related Products"
    }
  ]
}
{% endschema %}
